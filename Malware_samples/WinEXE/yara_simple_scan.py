#!/usr/bin/env python3

import os
import r2pipe
import argparse

def read_rules(r2):
    
#    (r.cmd("yara add {}".format(os.path.join("./yara.r",f)) for f in os.listdir("./yara.r") if os.path.isfile(os.path.join("./yara.r",f)))
    for f in os.listdir("./yara.r"):
        path = os.path.join("./yara.r",f)
        if os.path.isfile(path)==True:
            r2.cmd("yara add {}".format(path))
    


def scan(r2,data):
    nr_of_rules = r2.cmd("yara list").split("\n")
    del nr_of_rules[-1]

    data_yara=r2.cmd("yara scan").split("\n")
    del data_yara[-1]
    data['nr_of_hits']=len(data_yara)
    data['nr_of_rules']=len(nr_of_rules)
    data['results']=data_yara
    return data






def main(filename=None):
    if filename == None:
        return 0
    r2 = r2pipe.open(filename)
    

    read_rules(r2)
    data={} 
    result = scan(r2,data)
    print(f"Numer of rules : {result['nr_of_rules']}\nNumber of hits: {result['nr_of_hits']}\nResults:")
    for i in result['results']:
        print(f"\t\t{i}")

if __name__=="__main__":
    parser = argparse.ArgumentParser(description='Radare2 scanner')
    parser.add_argument('-f',help='in file to be scanned',required=True)
    args = parser.parse_args()

    main(args.f)

